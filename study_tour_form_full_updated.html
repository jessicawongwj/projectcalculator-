<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Tour Calculator</title>
  <style>
    @media print {
      input, select, button, .remove-btn, .add-row-btn, #calcBtn, #exportBtn, #exportProposalBtn { display: none; }
    }
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .form-row > div { flex: 1; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table th, table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    table th { background: #4b006e; color: #fff; }
    .summary { margin-top: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
    .summary .line { display: flex; gap: 10px; }
  </style>
</head>
<body>
<div class="form-row">
  <div>
    <label>Weeks<br><input id="weeks" type="number" placeholder="e.g. 1" min="1"/></label>
  </div>
  <div>
    <label>Time (hrs)<br><input id="timeRange" placeholder="e.g. 9am–3pm"/></label>
  </div>
</div>

<table id="costTable">
  <thead>
    <tr>
      <th>Category</th>
      <th>Item</th>
      <th>Qty</th>
      <th>Unit $</th>
      <th>Total $</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="costItems">
    <tr class="fixed-row">
      <td>
        <select disabled>
          <option selected>Application Fee</option>
        </select>
      </td>
      <td>
        <select disabled>
          <option selected>Application Fee</option>
        </select>
      </td>
      <td><input type="number" class="qty" value="1" min="1" onchange="updateFixedRowTotal(this)"/></td>
      <td><input type="number" class="unit" value="250" onchange="updateFixedRowTotal(this)"/></td>
      <td class="total">$250.00</td>
      <td><input type="text" class="notes" placeholder="Optional info"/></td>
      <td></td>
    </tr>
    <tr class="fixed-row">
      <td>
        <select disabled>
          <option selected>Labour</option>
        </select>
      </td>
      <td>
        <select class="item">
          <option>Trainer Cost - Business Days</option>
          <option>Trainer Cost - Weekend (20% Levy)</option>
          <option>Administrative Cost - Business Days</option>
          <option>Administrative Cost - Weekend (20% Levy)</option>
          <option>Media Team Cost – Business Days</option>
        </select>
      </td>
      <td><input type="number" class="qty" value="1" min="1" onchange="updateFixedRowTotal(this)"/></td>
      <td><input type="number" class="unit" value="0" onchange="updateFixedRowTotal(this)"/></td>
      <td class="total">$0.00</td>
      <td><input type="text" class="notes" placeholder="Optional info"/></td>
      <td></td>
    </tr>
  </tbody>
</table>

<div style="margin-top:20px;">
  <button class="add-row-btn" onclick="addRow()" style="background:#4b006e;color:#fff;padding:8px;border:none;cursor:pointer;">+ Add Cost Item</button>
  <button id="calcBtn" onclick="calculateTotal()" style="background:#4b006e;color:#fff;padding:8px;border:none;cursor:pointer;margin-left:10px;">Calculate</button>
  <button id="exportBtn" onclick="exportTable()" style="background:#4b006e;color:#fff;padding:8px;border:none;cursor:pointer;margin-left:10px;">Export Table (Internal)</button>
  <button id="exportProposalBtn" style="background:#4b006e;color:#fff;padding:8px;border:none;cursor:pointer;margin-left:10px;">Export Table for Proposal</button>
</div>

<div class="form-row" style="margin-top:20px;">
  <div style="flex:2;"></div>
  <div style="flex:1;">
    <label>Profit Margin (%)<br><input id="profitMargin" type="number" value="20" min="0"/></label>
  </div>
</div>

<div class="summary">
  <div class="line"><div class="label">Base</div><div id="baseTotal" class="value">$0.00</div></div>
  <div class="line"><div class="label">+ Profit</div><div id="profitAmt" class="value">$0.00</div></div>
  <div class="line"><div class="label">= Final</div><div id="finalTotal" class="value">$0.00</div></div>
  <div class="line"><div class="label">Price / Student</div><div id="pricePerStudent" class="value">$0.00</div></div>
</div>

<script>
  function updateFixedRowTotal(input) {
    const tr = input.closest('tr');
    const qty = parseFloat(tr.querySelector('.qty').value) || 0;
    const unit = parseFloat(tr.querySelector('.unit').value) || 0;
    tr.querySelector('.total').textContent = `$${(qty*unit).toFixed(2)}`;
    calculateTotal();
  }

  function addRow() {
    const tbody = document.getElementById('costItems');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="" placeholder="Category" /></td>
      <td><input type="text" value="" placeholder="Item" /></td>
      <td><input type="number" class="qty" value="1" min="1"/></td>
      <td><input type="number" class="unit" value="0"/></td>
      <td class="total">$0.00</td>
      <td><input type="text" class="notes" placeholder="Optional info"/></td>
      <td><button type="button" onclick="this.closest('tr').remove();calculateTotal();" class="remove-btn">Remove</button></td>
    `;
    tr.querySelector('.qty').addEventListener('input', function() {
      updateRowTotal(tr);
      calculateTotal();
    });
    tr.querySelector('.unit').addEventListener('input', function() {
      updateRowTotal(tr);
      calculateTotal();
    });
    tbody.appendChild(tr);
  }

  function updateRowTotal(tr) {
    const qty = parseFloat(tr.querySelector('.qty').value) || 0;
    const unit = parseFloat(tr.querySelector('.unit').value) || 0;
    tr.querySelector('.total').textContent = `$${(qty*unit).toFixed(2)}`;
  }

  function calculateTotal() {
    let base = 0;
    let baseForProfit = 0;
    document.querySelectorAll('#costItems tr').forEach((tr, idx) => {
      const totalCell = tr.querySelector('.total');
      if (!totalCell) return;
      const rowTotal = parseFloat(totalCell.textContent.replace('$','')) || 0;
      base += rowTotal;
      if (idx !== 0) { // Exclude Application Fee from profit
        baseForProfit += rowTotal;
      }
    });
    const profitPct = parseFloat(document.getElementById('profitMargin').value) || 0;
    const profit = baseForProfit * profitPct / 100;
    const finalTotal = base + profit;
    const num = parseInt(document.getElementById('numStudents')?.value) || 1;
    document.getElementById('baseTotal').textContent = `$${base.toFixed(2)}`;
    document.getElementById('profitAmt').textContent = `$${profit.toFixed(2)}`;
    document.getElementById('finalTotal').textContent = `$${finalTotal.toFixed(2)}`;
    document.getElementById('pricePerStudent').textContent = `$${(finalTotal/num).toFixed(2)}`;
  }

  // Internal Export: Full Table with all calculations
  function exportTable() {
    // Header: Item, Total
    let csv = 'Item,Total $\n';
    document.querySelectorAll('#costItems tr').forEach(tr => {
      // Get the item/component name
      let itemVal = '';
      let itemCell = tr.cells[1];
      if (itemCell) {
        const sel = itemCell.querySelector('select');
        if (sel) {
          itemVal = sel.value || sel.options[sel.selectedIndex].text;
        } else if (itemCell.querySelector('input')) {
          itemVal = itemCell.querySelector('input').value;
        } else {
          itemVal = itemCell.textContent.trim();
        }
      }
      // Get the total for this row
      let totalVal = tr.querySelector('.total') ? tr.querySelector('.total').textContent : '';
      if (itemVal && totalVal) {
        csv += `"${itemVal.replace(/"/g, '""')}",${totalVal}\n`;
      }
    });
    // Add final total at the end
    const finalTotal = document.getElementById('finalTotal').textContent;
    csv += `Final Total,${finalTotal}\n`;
    // Download CSV
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cost_summary.csv';
    a.click();
  }

  // Proposal Export: Only Item, Total, and Final Price (no profit/cost per student)
  function exportProposalTable() {
    let csv = 'Item,Total $\n';
    document.querySelectorAll('#costItems tr').forEach(tr => {
      let itemVal = '';
      let itemCell = tr.cells[1];
      if (itemCell) {
        const sel = itemCell.querySelector('select');
        if (sel) {
          itemVal = sel.value || sel.options[sel.selectedIndex].text;
        } else if (itemCell.querySelector('input')) {
          itemVal = itemCell.querySelector('input').value;
        } else {
          itemVal = itemCell.textContent.trim();
        }
      }
      let totalVal = tr.querySelector('.total') ? tr.querySelector('.total').textContent : '';
      if (itemVal && totalVal) {
        csv += `"${itemVal.replace(/"/g, '""')}",${totalVal}\n`;
      }
    });
    // Only add "Final Price" (no profit/cost per student breakdown)
    const finalTotal = document.getElementById('finalTotal').textContent;
    csv += `Final Price,${finalTotal}\n`;
    // Download CSV
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'proposal_cost_summary.csv';
    a.click();
  }
  document.getElementById('exportProposalBtn').onclick = exportProposalTable;
</script>
</body>
</html>
