<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Tour Calculator</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    input, select, textarea {
      height: 44px;
      line-height: normal;
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 7px;
      font-size: 15px;
      background: #f8f8fd;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #4b006e;
      background: #fff;
      outline: none;
    }
    body {
      background: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .form-container {
      background: #fff;
      max-width: 2200px;
      margin: 40px auto;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.10);
    }
    h2 {
      color: #4b006e;
      text-align: center;
      margin-bottom: 24px;
    }
    label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    button {
      background: #4b006e;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 7px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 8px;
    }
    button:hover {
      background: #35004d;
    }
    @media print {
      input, select, button, .remove-btn, .add-row-btn, #calcBtn, #exportBtn { display: none; }
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
      align-items: flex-start;
    }
    .form-row > div {
      flex: 1 1 calc(33.333% - 16px);
      min-width: 200px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    table th {
      background: #4b006e;
      color: #fff;
    }
    .summary {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }
    .summary .line {
      display: flex;
      gap: 10px;
    }
    .summary .label {
      width: 120px;
      font-weight: bold;
      text-align: right;
    }
    .summary .value {
      width: 100px;
      text-align: right;
    }
    button.remove-btn {
      background: none;
      border: none;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      color: #888;
      padding: 0 6px;
      margin-right: 4px;
    }
    button.remove-btn:hover {
      color: #444;
    }
    input.notes {
      width: 110px;
      font-size: 13px;
      padding: 6px;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div style="text-align:left; margin-bottom:20px;">
      <img src="charlton-brown-logo.jpeg" alt="Charlton Brown Logo" style="height:80px;">
    </div>
    <h2>STUDY TOUR</h2>
    <!-- Top six fields -->
    <div class="form-row">
      <div>
        <label for="studentGroupName">Student Group Name</label>
        <input id="studentGroupName" placeholder="e.g. entity"/>
      </div>
      <div>
        <label for="studentGroup">Student Group</label>
        <input id="studentGroup" placeholder="e.g. Year 9 (13–14yrs)"/>
      </div>
      <div>
        <label for="numStudents">Number of Students</label>
        <input id="numStudents" type="number" placeholder="e.g. 40" min="1"/>
      </div>
      <div>
        <label for="startDate">Date</label>
        <input id="startDate" type="date"/>
      </div>
      <div>
        <label for="weeks">Weeks</label>
        <input id="weeks" type="number" placeholder="e.g. 1" min="1"/>
      </div>
      <div>
        <label for="timeRange">Time (hrs)</label>
        <input id="timeRange" placeholder="e.g. 9am–3pm"/>
      </div>
    </div>
    <!-- Cost table -->
    <table id="costTable">
      <thead>
        <tr>
          <th>Category</th>
          <th>Item</th>
           <th style="width: 80px;">Qty</th>
    <th style="width: 120px;">Unit $</th>
          <th>Total $</th>
          <th>Optional Info</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="costItems">
        <tr class="fixed-row">
          <td><select disabled><option>Application Fee</option></select></td>
          <td><select disabled><option>Application Fee</option></select></td>
          <td><input type="number" class="qty" value="1" min="1" onchange="updateFixedRowTotal(this)"/></td>
          <td><input type="number" class="unit" value="250" onchange="updateFixedRowTotal(this)"/></td>
          <td class="total">$250.00</td>
          <td><input type="text" class="notes" placeholder="Optional info"/></td>
          <td><button class="remove-btn" style="font-size:12px;padding:0 6px;">x</button></td>
        </tr>
        <tr class="fixed-row">
          <td><select disabled><option>Labour</option></select></td>
          <td>
            <select class="item">
              <option>Trainer Cost - Business Days</option>
              <option>Trainer Cost - Weekend (20% Levy)</option>
              <option>Administrative Cost - Business Days</option>
              <option>Administrative Cost - Weekend (20% Levy)</option>
              <option>Media Team Cost – Business Days</option>
            </select>
          </td>
          <td><input type="number" class="qty" value="1" min="1" onchange="updateFixedRowTotal(this)"/></td>
          <td><input type="number" class="unit" value="0" onchange="updateFixedRowTotal(this)"/></td>
          <td class="total">$0.00</td>
          <td><input type="text" class="notes" placeholder="Optional info"/></td>
          <td><button class="remove-btn" style="font-size:12px;padding:0 6px;">x</button></td>
        </tr>
      </tbody>
    </table>
    <!-- Buttons -->
    <div style="text-align:right; margin-top:16px;">
      <button class="add-row-btn" onclick="addRow()">+ Add Cost Item</button>
      <button id="calcBtn" onclick="calculateTotal()">Calculate</button>
      <button id="exportBtn" onclick="exportTable()">Export Table</button>
    </div>
    <!-- Profit margin -->
    <div class="form-row" style="margin-top:24px;">
      <div></div><!-- spacer -->
      <div>
        <label for="profitMargin">Profit Margin (%)</label>
        <input id="profitMargin" type="number" value="20" min="0"/>
      </div>
    </div>
    <!-- Summary -->
    <div class="summary">
      <div class="line"><div class="label">Base</div><div id="baseTotal" class="value">$0.00</div></div>
      <div class="line"><div class="label">+ Profit</div><div id="profitAmt" class="value">$0.00</div></div>
      <div class="line"><div class="label">= Final</div><div id="finalTotal" class="value">$0.00</div></div>
      <div class="line"><div class="label">Price / Student</div><div id="pricePerStudent" class="value">$0.00</div></div>
    </div>
  </div>
  <script>
    // Update fixed rows (Application Fee & Labour)
    function updateFixedRowTotal(input) {
      const tr = input.closest('tr');
      const qty = parseFloat(tr.querySelector('.qty').value) || 0;
      const unit = parseFloat(tr.querySelector('.unit').value) || 0;
      tr.querySelector('.total').textContent = `$${(qty * unit).toFixed(2)}`;
      calculateTotal();
    }
    // Dataset of categories → items
    let dataset = {};
let defaultPrices = {};

fetch("https://myniet-my.sharepoint.com/:u:/g/personal/jessica_wong_niet_edu_au/EZ8f4IAtHQ1AjkoV-pzu1HQBiYTRU48IiUjqWTBszjKo3g?e=eXPYcO")
  .then(res => res.json())
  .then(data => {
    dataset = {};
    defaultPrices = {};

    data.forEach(row => {
      const cat = row["Category"];
      const item = row["Item"];
      const price = parseFloat(row["Default Price"]) || 0;

      if (!dataset[cat]) dataset[cat] = [];
      dataset[cat].push(item);
      defaultPrices[item] = price;
    });

    console.log("✅ Pricing loaded from JSON");
  })
  .catch(err => {
    console.error("⚠️ Failed to load pricing data:", err);
    alert("Unable to load the latest pricing data.");
  });
    function addRow() {
      const tbody = document.getElementById('costItems');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <select class="category">
            <option value="">Select category</option>
            ${Object.keys(dataset).map(c => `<option>${c}</option>`).join('')}
          </select>
        </td>
        <td><select class="item"><option value="">Select item</option></select></td>
        <td><input type="number" class="qty" value="1" min="1"/></td>
        <td><input type="number" class="unit" value="0"/></td>
        <td class="total">$0.00</td>
        <td><input type="text" class="notes" placeholder="Optional info"/></td>
        <td><button class="remove-btn" style="font-size:12px;padding:0 6px;" onclick="this.closest('tr').remove(); calculateTotal();">x</button></td>
      `;
      // insert after the two fixed rows
      const fixedRows = tbody.querySelectorAll('.fixed-row');
      if (fixedRows.length >= 2) {
        tbody.insertBefore(tr, fixedRows[1].nextSibling);
      } else {
        tbody.appendChild(tr);
      }
      // wire up events
      tr.querySelector('.category').addEventListener('change', function() {
        const items = dataset[this.value] || [];
        const sel = tr.querySelector('.item');
        sel.innerHTML = '<option>Select item</option>' + items.map(i => `<option>${i}</option>`).join('');
      });
      tr.querySelector('.item').addEventListener('change', function() {
        const price = defaultPrices[this.value] || 0;
        tr.querySelector('.unit').value = price;
        updateRowTotal(tr);
        calculateTotal();
        if (this.value === "Other Activities") {
          const td = this.parentElement;
          const input = document.createElement('input');
          input.type = "text";
          input.value = "Other Activities";
          input.className = "custom-activity";
          td.innerHTML = '';
          td.appendChild(input);
        }
      });
      ['qty','unit'].forEach(cls => {
        tr.querySelector(`.${cls}`).addEventListener('input', () => {
          updateRowTotal(tr);
          calculateTotal();
        });
      });
    }
    function updateRowTotal(tr) {
      const qty = parseFloat(tr.querySelector('.qty').value) || 0;
      const unit = parseFloat(tr.querySelector('.unit').value) || 0;
      tr.querySelector('.total').textContent = `$${(qty * unit).toFixed(2)}`;
    }
    function calculateTotal() {
      let base = 0;
      let baseForProfit = 0;
      document.querySelectorAll('#costItems tr').forEach((tr, idx) => {
        const totalCell = tr.querySelector('.total');
        if (!totalCell) return;
        const rowTotal = parseFloat(totalCell.textContent.replace('$','')) || 0;
        base += rowTotal;
        if (idx !== 0) baseForProfit += rowTotal;
      });
      const profitPct = parseFloat(document.getElementById('profitMargin').value) || 0;
      const profit = baseForProfit * profitPct / 100;
      const finalTotal = base + profit;
      const num = parseInt(document.getElementById('numStudents').value) || 1;
      document.getElementById('baseTotal').textContent = `$${base.toFixed(2)}`;
      document.getElementById('profitAmt').textContent = `$${profit.toFixed(2)}`;
      document.getElementById('finalTotal').textContent = `$${finalTotal.toFixed(2)}`;
      document.getElementById('pricePerStudent').textContent = `$${(finalTotal/num).toFixed(2)}`;
    }
    function exportTable() {
      let csv = 'Item,Total $,Notes\n';
      document.querySelectorAll('#costItems tr').forEach(tr => {
        let itemVal = '';
        const itemCell = tr.cells[1];
        if (itemCell) {
          const sel = itemCell.querySelector('select');
          if (sel) itemVal = sel.value || sel.options[sel.selectedIndex].text;
          else if (itemCell.querySelector('input')) itemVal = itemCell.querySelector('input').value;
          else itemVal = itemCell.textContent.trim();
        }
        const totalCell = tr.querySelector('.total');
        const totalVal = totalCell ? totalCell.textContent : '';
        const notesCell = tr.querySelector('.notes');
        const noteVal = notesCell ? notesCell.value : '';
        if (itemVal && totalVal) {
          csv += `"${itemVal.replace(/"/g, '""')}",${totalVal},"${noteVal.replace(/"/g, '""')}"\n`;
        }
      });
      csv += `Final Total,${document.getElementById('finalTotal').textContent},\n`;
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cost_summary.csv';
      a.click();
    }
  </script>
</body>
</html>

